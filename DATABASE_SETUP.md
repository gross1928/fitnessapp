# Настройка базы данных для ДаЕда

## Быстрый старт

1. Зайдите в ваш проект Supabase
2. Перейдите в раздел SQL Editor
3. Скопируйте и выполните содержимое файла `database_setup.sql`

> ⚠️ **Обновление:** SQL скрипт теперь безопасен для повторного выполнения - он удаляет существующие триггеры и политики перед созданием новых.

## Что включает схема

### Таблицы:
- **users** - профили пользователей с полными данными онбординга (включая пол, возраст, цели)
- **food_items** - база продуктов питания
- **meal_entries** - записи о приемах пищи
- **water_entries** - потребление воды
- **weight_entries** - записи веса и состава тела
- **health_analyses** - загруженные анализы здоровья
- **chat_messages** - история чата с AI

### Функции:
- `get_daily_nutrition()` - получение дневной статистики питания
- `get_daily_water()` - получение дневной статистики воды

### Безопасность:
- Row Level Security (RLS) для всех таблиц
- Пользователи видят только свои данные
- Политики настроены для работы с Telegram ID

## Поля для онбординга

В таблице `users` есть все необходимые поля:
- `name` - имя
- `age` - возраст  
- `gender` - пол ('male' / 'female')
- `height` - рост в см
- `current_weight` - текущий вес в кг
- `target_weight` - целевой вес в кг
- `goal_type` - тип цели ('lose' / 'gain' / 'maintain')
- `activity_level` - уровень активности
- `goal_deadline` - дата достижения цели

## Автоматически рассчитываемые поля

При завершении онбординга рассчитываются:
- `daily_calorie_target` - дневная норма калорий
- `daily_protein_target` - дневная норма белков
- `daily_fat_target` - дневная норма жиров  
- `daily_carb_target` - дневная норма углеводов
- `daily_water_target` - дневная норма воды

## Автоматическая регистрация

Система работает так:
1. При запуске приложения вызывается `/api/users/register`
2. API проверяет существование пользователя по `telegram_id`
3. Если пользователь новый - создается базовая запись
4. Пользователь перенаправляется на онбординг при `needsOnboarding: true`
5. После онбординга профиль дополняется всеми данными и рассчитываются цели

Онбординг сохраняет все поля как есть - ничего не удаляется! 